# ============================================================
# ì¡ë™ì‚¬ë‹ˆ í”„ë¡œì íŠ¸ â€” CI/CD ìë™ ë°°í¬
# main ë¸Œëœì¹˜ì— push ì‹œ OCI ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ìë™ ë°°í¬
# ============================================================

name: Deploy to OCI Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # 1) ë°°í¬ ì‹œì‘ ì•Œë¦¼ (ë¡œê·¸ìš©)
      - name: Print deployment info
        run: |
          echo "ğŸš€ Deploying jabdonsani..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      # 2) SSHë¡œ OCI ì„œë²„ ì ‘ì† â†’ git pull â†’ Docker ì¬ë¹Œë“œ
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            echo "========== ë°°í¬ ì‹œì‘ =========="

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/jabdonsani

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Docker Composeë¡œ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘
            echo "ğŸ³ Rebuilding and restarting containers..."
            sudo docker-compose down
            sudo docker-compose up -d --build

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up unused images..."
            sudo docker image prune -f

            echo "========== ë°°í¬ ì™„ë£Œ =========="
